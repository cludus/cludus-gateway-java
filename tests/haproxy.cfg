defaults
  mode    http
  log     global
  option  httplog
  option  http-server-close
  option  dontlognull
  option  redispatch
  option  contstats
  retries 3
  backlog 10000
  timeout client          25s
  timeout connect          5s
  timeout server          25s
# timeout tunnel available in ALOHA 5.5 or HAProxy 1.5-dev10 and higher
  timeout tunnel        3600s
  timeout http-keep-alive  1s
  timeout http-request    15s
  timeout queue           30s
  timeout tarpit          60s
  default-server inter 3s rise 2 fall 3
  option forwardfor

frontend cludus_gateway_frontend
  bind 0.0.0.0:443 ssl crt /usr/local/etc/haproxy/gateway-cludus-dev.pem ssl-min-ver TLSv1.2
  maxconn 100000
  acl is_gateway_host hdr_beg(host) -i gateway.cludus.dev
  use_backend cludus_gateway_backend if is_gateway_host

# frontend cludus_metrics_frontend
#   bind 0.0.0.0:443 ssl crt /usr/local/etc/haproxy/all-cludus-dev.pem ssl-min-ver TLSv1.2
#   maxconn 100000
#   acl is_metrics_host hdr_beg(host) -i metrics.cludus.dev
#   use_backend cludus_metrics_backend if is_metrics_host

frontend prometheus_stats
   bind *:8404
   http-request use-service prometheus-exporter if { path /prometheus/metrics }
   stats enable
   stats uri /stats
   stats refresh 10s

backend cludus_gateway_backend
  balance roundrobin
  server gateway1 gateway-1:8080 maxconn 10000 weight 10
  server gateway2 gateway-2:8080 maxconn 10000 weight 10
  server gateway3 gateway-3:8080 maxconn 10000 weight 10

backend cludus_metrics_backend
  balance roundrobin
  server prometheus prometheus:9090 maxconn 10000
